<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/fontawesome/css/all.min.css">
  <style>
    .view-toggle {
      display: flex;
      gap: 8px;
      background: white;
      padding: 4px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .view-toggle button {
      padding: 8px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 6px;
      color: #666;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .view-toggle button.active {
      background: var(--accent-color);
      color: white;
    }
    
    .view-toggle button:hover:not(.active) {
      background: #f5f5f5;
    }
    
    .sales-grid {
      display: none;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .sales-grid.active {
      display: grid;
    }
    
    .sale-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      position: relative;
    }
    
    .sale-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    .sale-card-header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-light-green) 100%);
      color: white;
      padding: 20px;
    }
    
    .sale-card-id {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    
    .sale-card-total {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .sale-card-date {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .sale-card-body {
      padding: 20px;
    }
    
    .sale-card-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .sale-card-info-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #666;
    }
    
    .sale-card-info-item i {
      width: 20px;
      text-align: center;
      color: var(--accent-color);
    }
    
    .sale-card-info-item strong {
      color: #333;
    }
    
    .sale-card-items {
      border-top: 1px solid #eee;
      padding-top: 16px;
      margin-top: 16px;
    }
    
    .sale-card-items-title {
      font-size: 13px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .sale-card-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 14px;
    }
    
    .sale-card-item-name {
      flex: 1;
      color: #333;
    }
    
    .sale-card-item-qty {
      margin: 0 12px;
      color: #666;
    }
    
    .sale-card-item-price {
      font-weight: 600;
      color: var(--accent-color);
    }
    
    .table-container {
      display: none;
    }
    
    .table-container.active {
      display: block;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #eee;
    }
    
    .pagination a,
    .pagination span {
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      color: #666;
      transition: all 0.2s;
    }
    
    .pagination a {
      background: white;
      border: 1px solid #ddd;
    }
    
    .pagination a:hover {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    .pagination .current {
      background: var(--accent-color);
      color: white;
      font-weight: 600;
      border: 1px solid var(--accent-color);
    }
    
    .pagination .disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .pagination-info {
      color: #666;
      font-size: 14px;
      margin-left: 16px;
    }
    
    .search-filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .search-box i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }
    
    .filter-box {
      position: relative;
    }
    
    .filter-box select {
      padding: 12px 40px 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      appearance: none;
      transition: all 0.2s;
      min-width: 160px;
    }
    
    .filter-box select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .filter-box i {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      pointer-events: none;
    }
    
    .clear-filters {
      padding: 12px 20px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .clear-filters:hover {
      background: #e0e0e0;
    }

    .items-list {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    .items-list-item {
      padding: 4px 0;
    }

    .expandable-items {
      cursor: pointer;
      color: var(--accent-color);
      font-weight: 600;
    }

    .expandable-items:hover {
      text-decoration: underline;
    }

    /* Mobile: Force card view */
    @media (max-width: 768px) {
      .view-toggle {
        display: none;
      }
      
      .sales-grid {
        display: grid !important;
        grid-template-columns: 1fr;
      }
      
      .table-container {
        display: none !important;
      }
      
      .flex-between {
        flex-direction: column;
        align-items: stretch !important;
        gap: 16px;
      }
      
      .flex-between > div:last-child {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .search-filter-bar {
        flex-direction: column;
      }
      
      .search-box,
      .filter-box select {
        width: 100%;
        min-width: 100%;
      }
      
      .pagination {
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .pagination-info {
        width: 100%;
        text-align: center;
        margin-left: 0;
        margin-top: 8px;
      }
    }
  </style>
</head>
<body>
  <%- include('../components/sidebar', { currentPath: '/employee/sales' }) %>
  
  <div class="main-content">
    <div style="min-height: 100vh; background-color: var(--bg-color); padding: 32px 20px;">
    <div class="container">
      <div class="flex-between mb-3">
        <div>
          <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">
            <i class="fas fa-receipt"></i> Sales Management
          </h1>
          <p style="color: #666;">View sales transactions</p>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
          <a href="/pos" class="btn btn-primary">
            <i class="fas fa-cash-register"></i>
            Go to POS
          </a>
          <div class="view-toggle">
            <button id="tableViewBtn" class="active" onclick="switchView('table')">
              <i class="fas fa-table"></i>
              Table
            </button>
            <button id="cardViewBtn" onclick="switchView('card')">
              <i class="fas fa-th"></i>
              Cards
            </button>
          </div>
        </div>
      </div>
      
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          <%= success %>
        </div>
      <% } %>
      
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-error">
          <i class="fas fa-exclamation-circle"></i>
          <%= error %>
        </div>
      <% } %>

      <!-- Search and Filter Bar -->
      <div class="search-filter-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search by product name..." 
            value="<%= search %>"
          >
        </div>
        
        <div class="filter-box">
          <select id="branchFilter">
            <option value="">All Branches</option>
            <% branches.forEach(branch => { %>
              <option value="<%= branch.id %>" <%= branchFilter == branch.id ? 'selected' : '' %>>
                <%= branch.name %>
              </option>
            <% }) %>
          </select>
          <i class="fas fa-chevron-down"></i>
        </div>
        
        <div class="filter-box">
          <select id="employeeFilter">
            <option value="">All Employees</option>
            <% employees.forEach(employee => { %>
              <option value="<%= employee.id %>" <%= employeeFilter == employee.id ? 'selected' : '' %>>
                <%= employee.name %>
              </option>
            <% }) %>
          </select>
          <i class="fas fa-chevron-down"></i>
        </div>

        <div class="filter-box">
          <select id="paymentMethodFilter">
            <option value="">All Payment Methods</option>
            <option value="cash" <%= paymentMethodFilter === 'cash' ? 'selected' : '' %>>Cash</option>
            <option value="card" <%= paymentMethodFilter === 'card' ? 'selected' : '' %>>Card</option>
            <option value="insurance" <%= paymentMethodFilter === 'insurance' ? 'selected' : '' %>>Insurance</option>
          </select>
          <i class="fas fa-chevron-down"></i>
        </div>

        <div class="filter-box">
          <select id="statusFilter">
            <option value="">All Statuses</option>
            <option value="paid" <%= statusFilter === 'paid' ? 'selected' : '' %>>Paid</option>
            <option value="pending" <%= statusFilter === 'pending' ? 'selected' : '' %>>Pending</option>
            <option value="refunded" <%= statusFilter === 'refunded' ? 'selected' : '' %>>Refunded</option>
          </select>
          <i class="fas fa-chevron-down"></i>
        </div>
        
        <% if (search || branchFilter || employeeFilter || paymentMethodFilter || statusFilter) { %>
          <button class="clear-filters" onclick="clearFilters()">
            <i class="fas fa-times"></i>
            Clear Filters
          </button>
        <% } %>
      </div>

      <!-- Table View -->
      <div class="table-container active fade-in">
        <% if (sales.length === 0) { %>
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <i class="fas fa-search" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="font-size: 24px; font-weight: 600; color: #666; margin-bottom: 12px;">No Sales Found</h3>
            <p style="font-size: 16px;">Try adjusting your search or filters to find what you're looking for.</p>
            <% if (search || branchFilter || employeeFilter || paymentMethodFilter) { %>
              <button onclick="clearFilters()" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-times"></i> Clear Filters
              </button>
            <% } %>
          </div>
        <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Sale ID</th>
              <th>Date</th>
              <th>Branch</th>
              <th>Employee</th>
              <th>Payment</th>
              <th>Status</th>
              <th>Items</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% sales.forEach(sale => { %>
              <tr>
                <td><code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-size: 12px;">#<%= sale.id %></code></td>
                <td><%= new Date(sale.created_at).toLocaleString('en-US', { 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric', 
                  hour: '2-digit', 
                  minute: '2-digit' 
                }) %></td>
                <td><%= sale.branch_name %></td>
                <td><%= sale.employee_name %></td>
                <td>
                  <span class="badge badge-<%= sale.payment_method === 'cash' ? 'info' : sale.payment_method === 'card' ? 'success' : 'primary' %>" style="text-transform: uppercase;">
                    <%= sale.payment_method %>
                  </span>
                </td>
                <td>
                  <span class="badge badge-<%= sale.payment_status === 'paid' ? 'success' : sale.payment_status === 'pending' ? 'warning' : 'danger' %>" style="text-transform: uppercase;">
                    <%= sale.payment_status %>
                  </span>
                </td>
                <td>
                  <div class="items-list">
                    <% if (sale.items.length <= 2) { %>
                      <% sale.items.forEach(item => { %>
                        <div class="items-list-item">
                          <%= item.product_name %> <strong>(×<%= item.quantity %>)</strong>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="items-list-item">
                        <%= sale.items[0].product_name %> <strong>(×<%= sale.items[0].quantity %>)</strong>
                      </div>
                      <div class="items-list-item">
                        <%= sale.items[1].product_name %> <strong>(×<%= sale.items[1].quantity %>)</strong>
                      </div>
                      <div class="items-list-item">
                        <span class="expandable-items" onclick="toggleItems(this, <%= sale.id %>)">
                          + <%= sale.items.length - 2 %> more items
                        </span>
                      </div>
                      <div id="moreItems<%= sale.id %>" style="display: none;">
                        <% for (let i = 2; i < sale.items.length; i++) { %>
                          <div class="items-list-item">
                            <%= sale.items[i].product_name %> <strong>(×<%= sale.items[i].quantity %>)</strong>
                          </div>
                        <% } %>
                      </div>
                    <% } %>
                  </div>
                </td>
                <td>
                  <div style="font-size: 16px; font-weight: 700; color: var(--accent-color);">
                    $<%= parseFloat(sale.total).toFixed(2) %>
                  </div>
                  <% if (sale.discount > 0) { %>
                    <small style="color: #999;">
                      Discount: 
                      <% if (sale.discount_type === 'percentage') { %>
                        <%= parseFloat(sale.discount).toFixed(0) %>%
                      <% } else { %>
                        -$<%= parseFloat(sale.discount).toFixed(2) %>
                      <% } %>
                    </small>
                  <% } %>
                </td>
                <td>
                  <a href="/employee/sales/print/<%= sale.id %>" target="_blank" class="btn btn-sm btn-outline" title="Print Receipt">
                    <i class="fas fa-print"></i>
                  </a>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <% } %>
      </div>
      
      <!-- Card View -->
      <div class="sales-grid">
        <% if (sales.length === 0) { %>
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #999;">
            <i class="fas fa-search" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="font-size: 24px; font-weight: 600; color: #666; margin-bottom: 12px;">No Sales Found</h3>
            <p style="font-size: 16px;">Try adjusting your search or filters to find what you're looking for.</p>
            <% if (search || branchFilter || employeeFilter || paymentMethodFilter) { %>
              <button onclick="clearFilters()" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-times"></i> Clear Filters
              </button>
            <% } %>
          </div>
        <% } else { %>
        <% sales.forEach(sale => { %>
          <div class="sale-card">
            <div class="sale-card-header">
              <div class="sale-card-id">Sale #<%= sale.id %></div>
              <div class="sale-card-total">$<%= parseFloat(sale.total).toFixed(2) %></div>
              <div class="sale-card-date">
                <i class="fas fa-clock"></i>
                <%= new Date(sale.created_at).toLocaleString('en-US', { 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric', 
                  hour: '2-digit', 
                  minute: '2-digit' 
                }) %>
              </div>
            </div>
            
            <div class="sale-card-body">
              <div class="sale-card-info">
                <div class="sale-card-info-item">
                  <i class="fas fa-building"></i>
                  <span><strong>Branch:</strong> <%= sale.branch_name %></span>
                </div>
                <div class="sale-card-info-item">
                  <i class="fas fa-user"></i>
                  <span><strong>Employee:</strong> <%= sale.employee_name %></span>
                </div>
                <div class="sale-card-info-item">
                  <i class="fas fa-shopping-bag"></i>
                  <span><strong>Items:</strong> <%= sale.item_count %> product<%= sale.item_count !== 1 ? 's' : '' %></span>
                </div>
                <div class="sale-card-info-item">
                  <% if (sale.payment_method === 'cash') { %>
                    <i class="fas fa-money-bill-wave"></i>
                    <span><strong>Payment:</strong> Cash</span>
                  <% } else if (sale.payment_method === 'card') { %>
                    <i class="fas fa-credit-card"></i>
                    <span><strong>Payment:</strong> Card</span>
                  <% } else { %>
                    <i class="fas fa-shield-alt"></i>
                    <span><strong>Payment:</strong> Insurance</span>
                  <% } %>
                </div>
                <div class="sale-card-info-item">
                  <i class="fas fa-check-circle"></i>
                  <span><strong>Status:</strong> 
                    <span class="badge badge-<%= sale.payment_status === 'paid' ? 'success' : sale.payment_status === 'pending' ? 'warning' : 'danger' %>" style="text-transform: uppercase;">
                      <%= sale.payment_status %>
                    </span>
                  </span>
                </div>
                <% if (sale.discount > 0) { %>
                  <div class="sale-card-info-item">
                    <i class="fas fa-tag"></i>
                    <span><strong>Discount:</strong> 
                      <% if (sale.discount_type === 'percentage') { %>
                        <%= parseFloat(sale.discount).toFixed(0) %>%
                      <% } else { %>
                        -$<%= parseFloat(sale.discount).toFixed(2) %>
                      <% } %>
                    </span>
                  </div>
                <% } %>
              </div>
              
              <div class="sale-card-items">
                <div class="sale-card-items-title">Items Purchased</div>
                <% sale.items.forEach(item => { %>
                  <div class="sale-card-item">
                    <div class="sale-card-item-name"><%= item.product_name %></div>
                    <div class="sale-card-item-qty">×<%= item.quantity %></div>
                    <div class="sale-card-item-price">$<%= parseFloat(item.subtotal).toFixed(2) %></div>
                  </div>
                <% }) %>
              </div>

              <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
                <a href="/employee/sales/print/<%= sale.id %>" target="_blank" class="btn btn-sm btn-primary" style="flex: 1;">
                  <i class="fas fa-print"></i> Print Receipt
                </a>
              </div>
            </div>
          </div>
        <% }) %>
        <% } %>
      </div>
      
      <!-- Pagination -->
      <% 

        const buildPaginationUrl = (page) => {
          const params = new URLSearchParams();
          params.set('page', page);
          if (search) params.set('search', search);
          if (branchFilter) params.set('branch', branchFilter);
          if (employeeFilter) params.set('employee', employeeFilter);
          if (paymentMethodFilter) params.set('paymentMethod', paymentMethodFilter);
          return '?' + params.toString();
        };
      %>
      <% if (totalPages > 1) { %>
        <div class="pagination">
          <% if (currentPage > 1) { %>
            <a href="<%= buildPaginationUrl(currentPage - 1) %>">
              <i class="fas fa-chevron-left"></i>
            </a>
          <% } else { %>
            <span class="disabled">
              <i class="fas fa-chevron-left"></i>
            </span>
          <% } %>
          
          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === currentPage) { %>
              <span class="current"><%= i %></span>
            <% } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
              <a href="<%= buildPaginationUrl(i) %>"><%= i %></a>
            <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
              <span>...</span>
            <% } %>
          <% } %>
          
          <% if (currentPage < totalPages) { %>
            <a href="<%= buildPaginationUrl(currentPage + 1) %>">
              <i class="fas fa-chevron-right"></i>
            </a>
          <% } else { %>
            <span class="disabled">
              <i class="fas fa-chevron-right"></i>
            </span>
          <% } %>
          
          <span class="pagination-info">
            Showing <%= sales.length %> of <%= totalSales %> sales
          </span>
        </div>
      <% } %>
    </div>
  </div>
  </div>
  
  <script>

    document.addEventListener('DOMContentLoaded', () => {
      const alerts = document.querySelectorAll('.alert');
      if (alerts.length > 0) {
        setTimeout(() => {
          alerts.forEach(alert => {
            alert.style.transition = 'opacity 0.5s ease';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
          });
        }, 3000);
      }
    });

    function toggleItems(element, saleId) {
      const moreItems = document.getElementById('moreItems' + saleId);
      if (moreItems.style.display === 'none') {
        moreItems.style.display = 'block';
        element.textContent = '- Show less';
      } else {
        moreItems.style.display = 'none';
        const itemCount = moreItems.children.length;
        element.textContent = '+ ' + itemCount + ' more items';
      }
    }

    function switchView(view) {
      const tableBtn = document.getElementById('tableViewBtn');
      const cardBtn = document.getElementById('cardViewBtn');
      const tableContainer = document.querySelector('.table-container');
      const cardContainer = document.querySelector('.sales-grid');

      tableBtn.classList.remove('active');
      cardBtn.classList.remove('active');
      tableContainer.classList.remove('active');
      cardContainer.classList.remove('active');

      if (view === 'table') {
        tableBtn.classList.add('active');
        tableContainer.classList.add('active');
      } else {
        cardBtn.classList.add('active');
        cardContainer.classList.add('active');
      }

      localStorage.setItem('employeeSalesView', view);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedView = localStorage.getItem('employeeSalesView') || 'table';
      const isMobile = window.innerWidth <= 768;
      const activeView = isMobile ? 'card' : savedView;
      switchView(activeView);
    });

    

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    async function applyFilters() {
      const searchValue = document.getElementById('searchInput').value;
      const branchValue = document.getElementById('branchFilter').value;
      const employeeValue = document.getElementById('employeeFilter').value;
      const paymentMethodValue = document.getElementById('paymentMethodFilter').value;
      const statusValue = document.getElementById('statusFilter').value;
      
      const params = new URLSearchParams();
      params.set('page', '1');
      if (searchValue) params.set('search', searchValue);
      if (branchValue) params.set('branch', branchValue);
      if (employeeValue) params.set('employee', employeeValue);
      if (paymentMethodValue) params.set('paymentMethod', paymentMethodValue);
      if (statusValue) params.set('status', statusValue);

      window.location.href = '/employee/sales?' + params.toString();
    }
    

    function clearFilters() {
      window.location.href = '/employee/sales';
    }
    

    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      const branchFilter = document.getElementById('branchFilter');
      const employeeFilter = document.getElementById('employeeFilter');
      const paymentMethodFilter = document.getElementById('paymentMethodFilter');
      const statusFilter = document.getElementById('statusFilter');
      

      const debouncedSearch = debounce(() => {
        applyFilters();
      }, 300);
      
      searchInput.addEventListener('input', debouncedSearch);
      

      const debouncedFilter = debounce(() => {
        applyFilters();
      }, 300);
      
      branchFilter.addEventListener('change', debouncedFilter);
      employeeFilter.addEventListener('change', debouncedFilter);
      paymentMethodFilter.addEventListener('change', debouncedFilter);
      statusFilter.addEventListener('change', debouncedFilter);
    });
  </script>
</body>
</html>

